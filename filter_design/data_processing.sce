clc
clear
raw_data = csvRead('tgt_at9.csv')
//raw_data = csvRead('normal.csv')

number_of_rows = 15
number_of_taps = 231
relevant_data_length = 1024
filtered_data_length = relevant_data_length - number_of_taps

raw_data = raw_data(1:number_of_rows , 1:relevant_data_length)

fir_coef = [
    0.000000000000000000,
    0.000000145404338621,
    0.000000555575539163,
    0.000001185942434145,
    0.000001984607885523,
    0.000002892388160588,
    0.000003842877389819,
    0.000004762544754746,
    0.000005570872996230,
    0.000006180547626520,
    0.000006497706848471,
    0.000006422262611541,
    0.000005848303447992,
    0.000004664589718870,
    0.000002755151645497,
    0.000000000000000000,
    -0.000003724041427130,
    -0.000008542373473977,
    -0.000014581522520510,
    -0.000021967899323895,
    -0.000030826412167037,
    -0.000041278932663488,
    -0.000053442614710410,
    -0.000067428069403219,
    -0.000083337401193829,
    -0.000101262113159020,
    -0.000121280891913072,
    -0.000143457285414002,
    -0.000167837289637491,
    -0.000194446862787729,
    -0.000223289388339129,
    -0.000254343110716253,
    -0.000287558569779833,
    -0.000322856062454051,
    -0.000360123161764237,
    -0.000399212325217169,
    -0.000439938625812120,
    -0.000482077639986717,
    -0.000525363527447701,
    -0.000569487338086697,
    -0.000614095581013164,
    -0.000658789090133609,
    -0.000703122219655399,
    -0.000746602401388159,
    -0.000788690093754049,
    -0.000828799150004300,
    -0.000866297630283093,
    -0.000900509078896742,
    -0.000930714284457679,
    -0.000956153536505927,
    -0.000976029387798135,
    -0.000989509926733592,
    -0.000995732559400569,
    -0.000993808295521939,
    -0.000982826527207600,
    -0.000961860283937304,
    -0.000929971941658895,
    -0.000886219358353572,
    -0.000829662402953388,
    -0.000759369839159349,
    -0.000674426520564309,
    -0.000573940848595693,
    -0.000457052440220375,
    -0.000322939948157168,
    -0.000170828972577949,
    0.000000000000000000,
    0.000190203697671243,
    0.000400368273153349,
    0.000631001693600885,
    0.000882526381863242,
    0.001155272181039943,
    0.001449469713700035,
    0.001765244205932193,
    0.002102609844473788,
    0.002461464732532130,
    0.002841586506569255,
    0.003242628672290262,
    0.003664117713379691,
    0.004105451021203207,
    0.004565895687773317,
    0.005044588197814543,
    0.005540535048809659,
    0.006052614320523339,
    0.006579578207748587,
    0.007120056521974671,
    0.007672561159407321,
    0.008235491524360532,
    0.008807140888565053,
    0.009385703658484061,
    0.009969283514374389,
    0.010555902376666433,
    0.011143510147339221,
    0.011729995166420459,
    0.012313195316623312,
    0.012890909702516601,
    0.013460910824584124,
    0.014020957163127552,
    0.014568806082265101,
    0.015102226960329078,
    0.015619014449815016,
    0.016117001767722013,
    0.016594073915679158,
    0.017048180728697442,
    0.017477349651734558,
    0.017879698144514681,
    0.018253445617202480,
    0.018596924802575618,
    0.018908592474250328,
    0.019187039425258179,
    0.019430999626808561,
    0.019639358493352382,
    0.019811160187032037,
    0.019945613902197162,
    0.020042099078816079,
    0.020100169502243356,
    0.020119556255834326,
    0.020100169502243356,
    0.020042099078816079,
    0.019945613902197162,
    0.019811160187032040,
    0.019639358493352382,
    0.019430999626808564,
    0.019187039425258182,
    0.018908592474250328,
    0.018596924802575618,
    0.018253445617202480,
    0.017879698144514681,
    0.017477349651734558,
    0.017048180728697442,
    0.016594073915679158,
    0.016117001767722017,
    0.015619014449815016,
    0.015102226960329080,
    0.014568806082265103,
    0.014020957163127554,
    0.013460910824584124,
    0.012890909702516596,
    0.012313195316623312,
    0.011729995166420462,
    0.011143510147339223,
    0.010555902376666437,
    0.009969283514374391,
    0.009385703658484063,
    0.008807140888565055,
    0.008235491524360532,
    0.007672561159407324,
    0.007120056521974672,
    0.006579578207748588,
    0.006052614320523342,
    0.005540535048809659,
    0.005044588197814543,
    0.004565895687773319,
    0.004105451021203207,
    0.003664117713379690,
    0.003242628672290262,
    0.002841586506569257,
    0.002461464732532131,
    0.002102609844473790,
    0.001765244205932194,
    0.001449469713700036,
    0.001155272181039943,
    0.000882526381863242,
    0.000631001693600885,
    0.000400368273153349,
    0.000190203697671243,
    0.000000000000000000,
    -0.000170828972577949,
    -0.000322939948157167,
    -0.000457052440220375,
    -0.000573940848595693,
    -0.000674426520564310,
    -0.000759369839159349,
    -0.000829662402953388,
    -0.000886219358353573,
    -0.000929971941658895,
    -0.000961860283937306,
    -0.000982826527207601,
    -0.000993808295521939,
    -0.000995732559400568,
    -0.000989509926733592,
    -0.000976029387798135,
    -0.000956153536505928,
    -0.000930714284457679,
    -0.000900509078896743,
    -0.000866297630283094,
    -0.000828799150004300,
    -0.000788690093754051,
    -0.000746602401388159,
    -0.000703122219655399,
    -0.000658789090133609,
    -0.000614095581013164,
    -0.000569487338086698,
    -0.000525363527447702,
    -0.000482077639986717,
    -0.000439938625812120,
    -0.000399212325217169,
    -0.000360123161764237,
    -0.000322856062454053,
    -0.000287558569779833,
    -0.000254343110716253,
    -0.000223289388339129,
    -0.000194446862787728,
    -0.000167837289637491,
    -0.000143457285414002,
    -0.000121280891913073,
    -0.000101262113159020,
    -0.000083337401193830,
    -0.000067428069403219,
    -0.000053442614710410,
    -0.000041278932663488,
    -0.000030826412167037,
    -0.000021967899323895,
    -0.000014581522520510,
    -0.000008542373473977,
    -0.000003724041427130,
    0.000000000000000000,
    0.000002755151645497,
    0.000004664589718870,
    0.000005848303447992,
    0.000006422262611541,
    0.000006497706848471,
    0.000006180547626520,
    0.000005570872996230,
    0.000004762544754746,
    0.000003842877389819,
    0.000002892388160588,
    0.000001984607885523,
    0.000001185942434145,
    0.000000555575539163,
    0.000000145404338621,
    0.000000000000000000]

fir_coef = fir_coef'

volt_data = (3.3 / 65535) .* raw_data
//plot(linspace(1,1024,1024), volt_data)

filtered_volts = zeros(number_of_rows, relevant_data_length - number_of_taps)

//Apply the FIR filter
for row = 1:number_of_rows
    for window_location = 1:relevant_data_length - number_of_taps
          for tap_comb = 1:number_of_taps
            filtered_volts(row, window_location) = filtered_volts(row, window_location) + (volt_data(row, window_location+tap_comb) *  fir_coef(tap_comb))
          end  
    end
end

//Apply filter 2
/*
f1_a0 = 0.96906992
f1_b0 = 0.01546504
f1_b1 = 0.01546504
*/
f1_a0 = 0.98441445
f1_b0 = 0.00779278
f1_b1 = 0.00779278

 //yfilt[i] = a[1]*yfilt[i-1] + b[0]*y[i] + b[1]*y[i-1];
filtered_volts_2 = zeros(number_of_rows, relevant_data_length - 1)
for row = 1:number_of_rows
    filtered_volts_2(row, 1) = volt_data(row, 1)    
end

for row = 1:number_of_rows
    for window_location = 2:relevant_data_length
        filtered_volts_2(row, window_location) = (f1_a0 * filtered_volts_2(row, window_location-1)) + (f1_b0 * volt_data(row, window_location)) + (f1_b0 * volt_data(row, window_location - 1))   
    end
end


//plot(linspace(1,filtered_data_length, filtered_volts)
plot(linspace(1,filtered_data_length, filtered_data_length), filtered_volts(1,:), 'g')
plot(linspace(1,relevant_data_length, relevant_data_length), volt_data(1,:), 'r')
plot(linspace(1,relevant_data_length, relevant_data_length), filtered_volts_2(1,:), 'b')

//Calculate FFTs
/*
freq_data = fft(raw_data(1,1:relevant_data_length - number_of_taps))
post_filter_freq_data = fft(filtered_volts(1,1:relevant_data_length - number_of_taps))
freq_data(1) = 0
post_filter_freq_data(1) = 0
*/

//Plot
//plot(freq_data(1:relevant_data_length/2),'b')
//plot(post_filter_freq_data(1:relevant_data_length/2), 'r')
